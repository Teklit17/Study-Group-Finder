@model IEnumerable<SG_Finder.Models.StudyGroup>

@{
    ViewBag.Title = "title";
    Layout = "_Layout";
}
<input type="hidden" id="currentUserId" value="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value" />
<button id="createStudyGroupButton" class="btn btn-primary mb-4">Create a new Study Group...</button>

<div id="createStudyGroupForm" class="mb-4" style="display:none;">
    <form id="createStudyGroupFormId">
        <div class="form-group">
            <label for="GroupName">Group Name:</label>
            <input type="text" id="GroupName" name="GroupName" class="form-control" required />
        </div>
        <div class="form-group">
            <label for="GroupDescription">Group Description:</label>
            <input type="text" id="GroupDescription" name="GroupDescription" class="form-control" required />
        </div>
        <div class="form-group">
            <label for="MaxGroupMembers">Max Number of Group Members:</label>
            <input type="number" id="MaxGroupMembers" name="MaxGroupMembers" class="form-control" required min="1" />
        </div>
        <div class="form-group">
            <label>Require approval for new members:</label>
            <div>
                <button type="button" id="approvalYes" class="btn btn-secondary">Yes</button>
                <button type="button" id="approvalNo" class="btn btn-secondary">No</button>
            </div>
            <input type="hidden" id="RequiresApproval" name="RequiresApproval" value="false" />
        </div>
        <button id="SubmitButton" type="submit" class="btn btn-success">Submit</button>
    </form>
</div>

<!-- Search groups -->
<div id="searchInputContainer" class="input-group mb-4">
    <input type="text" id="searchInput" class="form-control" placeholder="Search for study groups..." />
    <div class="input-group-append">
        <button id="searchButton" class="btn btn-outline-secondary">Search</button>
    </div>
</div>

<!-- Display groups -->
<div id="CreatedGroups">
    <h3 class="StudyGroupHeader">Or join an existing group:</h3>
    <div id="searchResults">
        <div class="row">
            @foreach (var group in Model)
            {
            var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var isMember = group.GroupMembers.Any(m => m.ApplicationUserId == currentUserId);
            var isCreator = group.CreatorId == currentUserId;
            var hasPendingRequest = group.PendingMembers.Any(m => m.ApplicationUserId == currentUserId);

            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title group-name" style="cursor:pointer;" data-id="@group.Id">@group.GroupName</h5>
                        <div class="group-details" style="display:none;">
                            <p class="card-text">@group.GroupDescription</p>
                            <p><strong>Group Members</strong> (Max: @group.MaxGroupMembers)<strong>:</strong></p>
                            <ul>
                                <li><b><em>@group.GroupMembers.FirstOrDefault(m => m.ApplicationUserId == group.CreatorId)?.ApplicationUser.UserName</em></b>(Creator)</li>
                                @foreach (var member in group.GroupMembers.Where(m => m.ApplicationUserId != group.CreatorId))
                                {
                                    <li>
                                        @member.ApplicationUser.UserName
                                        @if (isCreator)
                                        {
                                            <button class="RemoveMemberButton" data-group-id="@group.Id" data-user-id="@member.ApplicationUserId">Remove</button>
                                        }
                                    </li>
                                }
                            </ul>

                            <!-- Pending Requests Section -->
                            @if (isCreator && group.PendingMembers.Any())
                            {
                            <p><strong>Pending Requests:</strong></p>
                            <ul>
                                @foreach (var pendingMember in group.PendingMembers)
                                {
                                <li>
                                    @pendingMember.ApplicationUser.UserName
                                    <button class="btn btn-success ApproveMemberButton" data-group-id="@group.Id" data-user-id="@pendingMember.ApplicationUserId">Approve</button>
                                    <button class="btn btn-danger RejectMemberButton" data-group-id="@group.Id" data-user-id="@pendingMember.ApplicationUserId">Reject</button>
                                </li>
                                }
                            </ul>
                            }

                            <!-- Join or Leave Group Button -->
                            @if (!isCreator)
                            {
                                if (isMember)
                                {
                                    <button class="btn btn-danger LeaveGroupButton" data-id="@group.Id">Leave @group.GroupName</button>
                                }
                                else if (hasPendingRequest)
                                {
                                    <button class="btn btn-secondary" disabled>Request Pending</button>
                                }
                                else
                                {
                                    <button class="btn btn-primary JoinGroupButton" data-id="@group.Id">
                                        @(group.RequiresApproval ? "Request to join " + @group.GroupName : "Join " + @group.GroupName)
                                    </button>
                                }
                            }

                            <!-- Delete Group Button -->
                            @if (isCreator)
                            {
                                <button class="btn btn-danger DeleteGroupButton" data-id="@group.Id">Delete @group.GroupName</button>
                            }
                        </div>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
</div>